const path = require('path')
const webpack = require('webpack')
const serverConfig = require('./webpack.server.config')

module.exports = function setupDevServer(app, cb){
    const readyPromise = new Promise(r => { resolve = r })

    // watch and update server renderer
    const serverCompiler = webpack(serverConfig)
    const mfs = new MFS()
    serverCompiler.outputFileSystem = mfs
    serverCompiler.watch({}, (err, stats) => {
        if (err) throw err
        stats = stats.toJson()
        stats.errors.forEach(err => console.error(err))
        stats.warnings.forEach(err => console.warn(err))
        const readFile = file => mfs.readFileSync(path.join(clientConfig.output.path, file), 'utf-8')

        // read bundle generated by vue-ssr-webpack-plugin
        bundle = JSON.parse(readFile('vue-ssr-server-bundle.json'))
        if (clientManifest) {
        ready(bundle, {
            clientManifest
        })
        }
    })
    return readyPromise
}